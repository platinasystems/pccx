#!/bin/sh

set -e

. /usr/share/pccx/rc.sh

pccx wait postgres

pccx merge /home/scripts/microservice/yaml-combiner \
	/home/conf/default.yml /usr/share/pccx/${0##*/}.yml /run/config.yml

pccx trace MAAS

# FIXME integrate this
/usr/bin/swagger.sh

PGPASSWORD="$POSTGRES_PASSWORD" psql \
        -U "$POSTGRES_USER" \
        -h "$HOST_POSTGRES" \
        -e "$DB_NAME_POSTGRES" \
        -f /home/scripts/db/init.sql \
        -v "role=$DB_USER_MAAS" \
        -v "passwd=$DB_PASSWORD_MAAS" \
        -v "db=$DB_NAME_MAAS" \
        -v "dbschema=$DB_SCHEMA_MAAS"
PGPASSWORD="$DB_PASSWORD_MAAS" psql \
        -U "$DB_USER_MAAS" \
        -h "$HOST_POSTGRES" \
        -e "$DB_NAME_MAAS" \
        -f /home/scripts/db/schema.sql

pccx exec MAAS /home/maas \
	--overrideSystemProperties \
	--configProfile docker \
	--configUri "/run/config.yml" \
	--configBranch "$CONFIG_BRANCH_MAAS" \
	--dbHost "$HOST_POSTGRES" \
	--dbName "$DB_NAME_MAAS" \
	--dbUsername "$DB_USER_MAAS" \
	--dbPassword "$DB_PASSWORD_MAAS" \
	--phAccessKey "$PHONEHOME_ACCESS_KEY" \
	--phSecretKey "$PHONEHOME_SECRET_KEY" \
	--useHostnameAsAddress \
	--useHostnameAsName \
	--registryAddress "$HOST_APIREGISTRY" \
	--maxRegistrationRetry 5 \
	--orchestrationGitPath=/home/orchestration
